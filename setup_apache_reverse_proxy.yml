- set_fact:
    ssl_dir: "/etc/apache2/ssl"
    use_openssl_module: False

- set_fact:
    use_openssl_module: True
  when: "{{ ansible_version.string | version_compare('2.3', '>=') }}"


- name: Install Apache
  apt: name={{ item }} update_cache=yes state=present
  with_items:
    - apache2

- name: enable apache mods
  apache2_module: name={{ item }} state=present
  with_items:
    - proxy
    - proxy_http
    - ssl
  #notify: restart apache TODO: convert to role!

- name: make directory for ssl certs
  file: path={{ ssl_dir }} state=directory

# New Modules Introduced in Ansible 2.3
# - name: generate private key
#   openssl_privatekey:
#     path: "{{ ssl_dir}}/{{ ansible_hostname }}.pem"
#   when: use_openssl_module
#
# - name: generate csr
#   openssl_csr:
#     path: /etc/apache2/ssl/{{ ansible_hostname }}.csr
#     privatekey_path: "{{ ssl_dir}}/{{ ansible_hostname }}.pem"
#     countryName: US
#     organizationName: ContrastEOP
#     emailAddress: support@contrastsecurity.com
#     commonName: "{{ ansible_hostname }}"
#   when: use_openssl_module
#
# - name: generate 509X cert
#   openssl_publickey:
#     path: "{{ ssl_dir }}/{{ ansible_hostname }}.crt"
#     privatekey_path: "{{ ssl_dir }}/{{ ansible_hostname }}.pem"
#   when: use_openssl_module
# End use of new modules

- name: generate private key
  command: openssl genrsa -out {{ ssl_dir }}/{{ ansible_hostname }}.key 2048
  when: not use_openssl_module

- name: generate csr
  command: openssl req -nodes \
                       -new \
                       -subj "/C=US/O=ContrastEOP/CN={{ ansible_hostname }}"
                       -key {{ ssl_dir }}/{{ ansible_hostname }}.key \
                       -out {{ ssl_dir }}/{{ ansible_hostname }}.csr
  when: not use_openssl_module

- name: generate 509X cert
  command: openssl x509 -req \
                        -days 365 \
                        -in {{ ssl_dir }}/{{ ansible_hostname }}.csr \
                        -signkey {{ ssl_dir }}/{{ ansible_hostname }}.key \
                        -out {{ ssl_dir }}/{{ ansible_hostname }}.crt
  when: not use_openssl_module

- name: Copy Apache2 SSL Template
  template: src=contrast-eop-demo.conf dest=/etc/apache2/sites-available/

- name: restart apache
  service: state=restarted name=apache2
